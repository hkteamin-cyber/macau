<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>é¦™æ¸¯éƒµæ”¿è²¨é‹ç³»çµ± (æ‰‹æ©Ÿç‰ˆ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <style>
    .container{background:rgba(0,0,0,.2);backdrop-filter:blur(10px);border-radius:15px;padding:20px}
    .header{text-align:center;margin-bottom:20px;padding:15px;background:linear-gradient(135deg,#0f4c4c,#2d5a27);border-radius:12px}
    .header h1{font-size:22px;margin-bottom:6px}
    .header p{font-size:14px;opacity:.9}
    .tabs{display:flex;justify-content:space-around;gap:8px;margin-bottom:20px}
    .tab{padding:12px;text-align:center;background:rgba(0,0,0,.2);border-radius:8px;color:#e8f5e8;border:none;font-size:16px;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}
    .tab.active{background:#2d5a27}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card{background:rgba(0,0,0,.25);border-radius:12px;padding:20px;margin-bottom:20px}
    .card-title{font-size:18px;font-weight:bold;margin-bottom:15px;color:#90EE90;text-align:center}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600}
    .form-group input{width:150px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-size:16px;-webkit-user-select:text;user-select:text}
    .bag-input{width:80px;}
    .btn{width:100%;padding:14px;border:none;border-radius:10px;margin:6px 0;font-size:16px;font-weight:600;color:#fff;cursor:pointer;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:rgba(0,0,0,0);touch-action:manipulation}
    .btn-primary{background:#2d5a27}
    .btn-secondary{background:#1a4d3a}
    .btn-success{background:#20c997}
    .btn-danger{background:#a0522d}
    .records-container{
      background:rgba(0,0,0,.1);
      border-radius:12px;
      padding:15px;
      max-height:none;
      overflow-y:visible;
      overflow-x:hidden;
      font-size: 18px;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }
    .record-item{background:rgba(0,0,0,.25);border-radius:8px;padding:12px;margin-bottom:12px}
    .record-header{display:flex;flex-direction:column;margin-bottom:8px}
    .record-title{font-weight:bold;color:#90EE90}
    .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .summary-item{background:rgba(0,0,0,.25);border-radius:8px;padding:15px;text-align:center}
    .summary-label{font-size:13px;opacity:.9}
    .summary-value{font-size:20px;font-weight:bold;color:#90EE90}
    .workflow-hint{background:rgba(74,124,89,.2);border:1px solid rgba(144,238,144,.3);border-radius:8px;padding:12px;margin-bottom:15px;text-align:center;font-size:14px}
    .notification-area{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin-top:10px;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    .notification-area #notificationText{flex:1;min-width:200px}
     .notification-area .btn{flex:0 0 auto;width:auto;padding:12px 16px}
     @media (max-width: 360px){
       .notification-area{gap:8px}
       .notification-area #notificationText{min-width:160px}
     }
     .custom-confirm{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center}
     .custom-confirm-dialog{background:#2d5a27;border-radius:12px;padding:20px;max-width:300px;width:90%;text-align:center}
     .custom-confirm-title{font-size:18px;font-weight:bold;margin-bottom:15px;color:#90EE90}
     .custom-confirm-buttons{display:flex;gap:10px;margin-top:15px}
     .custom-confirm-btn{flex:1;padding:12px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer}
     .confirm-yes{background:#20c997;color:#fff}
     .confirm-no{background:#a0522d;color:#fff}
   /* å„²å­˜æ­·å²è¡¨æ ¼æ¨£å¼ */
    .saved-records-container{background:rgba(0,0,0,0.35);border-radius:12px;padding:15px;max-height:500px;overflow-y:auto;font-size:14px;}
    .saved-record-table{width:100%;border-collapse:collapse;margin-bottom:15px;background:rgba(0,0,0,0.4);border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
    .saved-record-table th{background:linear-gradient(135deg,#2d5a27,#1e3f1a);color:#ffffff;padding:12px 10px;text-align:center;font-weight:600;border-bottom:2px solid rgba(255,255,255,0.2);font-size:13px;letter-spacing:0.5px;}
    .saved-record-table td{padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);color:#eaffea;font-size:13px;transition:background-color 0.2s ease;}
    .saved-record-table tr:last-child td{border-bottom:none;}
    .saved-record-table tr:nth-child(even){background:rgba(255,255,255,0.05);}
    .saved-record-table tr:hover td{background:rgba(144,238,144,0.1);}
    .saved-record-date{font-weight:bold;color:#90EE90;font-size:14px;margin-bottom:10px;text-align:center;padding:8px;background:rgba(45,90,39,0.3);border-radius:6px;}
    .detail-section-title{font-weight:bold;color:#90EE90;margin:15px 0 8px 0;font-size:15px;padding:8px 12px;background:rgba(45,90,39,0.2);border-radius:6px;border-left:4px solid #90EE90;}
    .saved-record-item{margin-bottom:25px;border:1px solid rgba(144,238,144,0.2);border-radius:12px;padding:18px;background:rgba(0,0,0,0.25);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
    .notification-text-container{background:rgba(0,0,0,0.5);padding:12px;border-radius:8px;margin-top:15px;border-left:4px solid #90EE90;}
    .manual-plates-info{background:rgba(144,238,144,0.1);padding:10px;border-radius:8px;margin-top:10px;border:1px solid rgba(144,238,144,0.3);}
    /* éŸ¿æ‡‰å¼è¡¨æ ¼ */
    @media (max-width: 768px) {
      .saved-record-table th, .saved-record-table td{padding:8px 6px;font-size:12px;}
      .saved-record-table th{padding:10px 6px;}
      .detail-section-title{font-size:14px;padding:6px 10px;}
      .saved-record-date{font-size:13px;}
    }
   /* High-contrast overrides for better readability */
    body{background:#0c1d17;color:#f4fff4;-webkit-font-smoothing:antialiased}
    .container{background:rgba(0,0,0,0.45)}
    .card{background:rgba(0,0,0,0.55)}
    .records-container{background:rgba(0,0,0,0.35);color:#ffffff}
    .record-item{background:rgba(0,0,0,0.55)}
    .form-group label{color:#eaffea}
    .form-group input{background:#0f2a23;border-color:rgba(255,255,255,0.35);color:#ffffff}
    .form-group input::placeholder{color:rgba(255,255,255,0.65)}
    .notification-area{background:rgba(0,0,0,0.55)}
    .summary-label{color:#eaffea}
    .summary-value{color:#b8ffb8}
    .tab{background:rgba(255,255,255,0.06)}
    .tab.active{background:#2d5a27;color:#ffffff}
    .btn-primary{background:#1b6f36;color:#fff}
    .btn-secondary{background:#146c43;color:#fff}
    .btn-danger{background:#b02a37;color:#fff}
    .btn-success{background:#0e8f5b;color:#fff}
    .btn:focus-visible,.form-group input:focus-visible,button:focus-visible{outline:3px solid #90EE90;outline-offset:2px}
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0c1d17">
    <link rel="apple-touch-icon" href="icon-192.svg">
</head>
<body>
  <div id="customConfirm" class="custom-confirm" style="display:none;" aria-hidden="true">
    <div class="custom-confirm-dialog" role="dialog" aria-modal="true">
      <div class="custom-confirm-title">ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼</div>
      <div class="custom-confirm-buttons">
        <button id="confirmNo" class="custom-confirm-btn confirm-no" ontouchstart="">å–æ¶ˆ</button>
        <button id="confirmYes" class="custom-confirm-btn confirm-yes" ontouchstart="">ç¢ºå®š</button>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ¿ é¦™æ¸¯éƒµæ”¿è²¨é‹ç³»çµ±</h1>
      <p>å…¥è¢‹è¨ˆç®— â†’ æœ¬åœ°æ•¸æ“š â†’ ç¸½çµå ±è¡¨åŠé€šå‘Š</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('calculator',this)" ontouchstart="">å…¥è¢‹</button>
      <button class="tab" onclick="showTab('local',this)" ontouchstart="">æœ¬åœ°</button>
      <button class="tab" onclick="showTab('dashboard',this)" ontouchstart="">ç¸½çµ</button>
    </div>

    <!-- å…¥è¢‹è¨ˆç®— -->
    <div id="calculator" class="tab-content active">

      <div class="card">
        <div class="card-title">ğŸ§® å…¥è¢‹è¨ˆç®—å™¨</div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label>ğŸ“¦ ç‰ˆè™Ÿ *</label>
          <select id="plateNumber" class="form-control"></select>
        </div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">âš–ï¸ é‡é‡</label>
          <input type="number" id="weight" step="0.1" min="0" inputmode="decimal" autocomplete="off" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">ğŸ“Š ç¸½ä»¶æ•¸</label>
          <input type="number" id="totalItems" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">å…¥è¢‹æ•¸</label>
          <div id="bagInputs" style="display: flex; flex-wrap: wrap; gap: 5px;">
            <input type="number" class="bag-input" placeholder="è¢‹1" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
            <input type="number" class="bag-input" placeholder="è¢‹2" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
          </div>
          <button type="button" onclick="addMoreBags()" class="btn btn-secondary" style="width: 80px;">+ è¢‹</button>
        </div>
        <button class="btn btn-primary" onclick="addBaggingRecord()" ontouchstart="">â• ç¢ºèªè¨˜éŒ„</button>

      </div>

      <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap: wrap;">
        <div class="card" style="flex:1;">
          <div class="card-title">ğŸ“‹ å·²è¨˜éŒ„ç‰ˆè™Ÿ</div>
          <div class="records-container" id="recordsList">
            <p style="text-align:center;opacity:.7;">å°šç„¡è¨˜éŒ„</p>
          </div>
        </div>
        <div class="card" style="min-width: 160px;">
          <div class="card-title">ğŸ§® å…¥è¢‹æ•¸</div>
          <div style="text-align:center;margin:10px 0;">
            <div>å…¥è¢‹çµæœ</div>
            <div id="baggingResult" style="font-size:22px;font-weight:bold;color:#90EE90;">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æœ¬åœ°æ•¸æ“š -->
    <div id="local" class="tab-content">

      <div class="card">
        <div class="card-title">æœ¬åœ°è²¨ç®¡ç†</div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">âš–ï¸ é‡é‡</label>
          <input type="number" id="localWeight" step="0.1" min="0" inputmode="decimal" autocomplete="off" oninput="updateLocalData()" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">ğŸ“Š ä»¶æ•¸</label>
          <input type="number" id="localItems" min="0" inputmode="numeric" autocomplete="off" oninput="updateLocalData()" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label style="margin-right: 10px;">ğŸ§³ å£“ç¸®</label>
          <input type="number" id="localCompressed" min="0" inputmode="numeric" autocomplete="off" oninput="updateLocalData()" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <button class="btn btn-primary" onclick="saveLocalData()" ontouchstart="">ğŸ’¾ ä¿å­˜æœ¬åœ°æ•¸æ“š</button>
      </div>
      <div class="card">
        <div class="card-title">æœ¬åœ°æ•¸æ“šçµ±è¨ˆ</div>
        <div class="summary-grid">
          <div class="summary-item"><div class="summary-label">ä»¶æ•¸</div><div class="summary-value" id="localItemsDisplay">0</div></div>
          <div class="summary-item"><div class="summary-label">é‡é‡</div><div class="summary-value" id="localWeightDisplay">0.0</div></div>
          <div class="summary-item"><div class="summary-label">å£“ç¸®è¢‹</div><div class="summary-value" id="localCompressedDisplay">0</div></div>
        </div>
      </div>
    </div>

    <!-- ç¸½çµå ±è¡¨ -->
    <div id="dashboard" class="tab-content">

      <!-- éš±è—å…¥è¢‹çµ±è¨ˆ div -->
      <!--
      <div class="card">
        <div class="card-title">ğŸ“ˆ å…¥è¢‹çµ±è¨ˆ</div>
        <div class="summary-grid">
          <div class="summary-item"><div class="summary-label">ç¸½ç‰ˆæ•¸</div><div class="summary-value" id="totalPlates">0</div></div>
          <div class="summary-item"><div class="summary-label">ç¸½ä»¶æ•¸</div><div class="summary-value" id="totalItemsSum">0</div></div>
          <div class="summary-item"><div class="summary-label">ç¸½é‡é‡</div><div class="summary-value" id="totalWeight">0.0</div></div>
          <div class="summary-item"><div class="summary-label">ç¸½å£“ç¸®è¢‹</div><div class="summary-value" id="totalCompressed">0</div></div>
        </div>
      </div>
      -->
      <div class="card">
        <div class="card-title">ğŸ¯ ç¸½çµå ±è¡¨</div>
        <div class="summary-grid">
          <div class="summary-item" style="grid-column: 1; grid-row: 1;"><div class="summary-label">ç¸½ç‰ˆæ•¸</div><div class="summary-value" id="grandTotalPlates">0</div></div>
          <div class="summary-item" style="grid-column: 1; grid-row: 2;"><div class="summary-label">ç¸½é‡é‡</div><div class="summary-value" id="grandTotalWeight">0.0</div></div>
          <div class="summary-item" style="grid-column: 2; grid-row: 1;"><div class="summary-label">ç¸½ä»¶æ•¸</div><div class="summary-value" id="grandTotalItems">0</div></div>
          <div class="summary-item" style="grid-column: 2; grid-row: 2;"><div class="summary-label">ç¸½å£“ç¸®è¢‹</div><div class="summary-value" id="grandTotalCompressed">0</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“¢ ç”Ÿæˆé€šå‘Š</div>
        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
          <label for="manualPlates" style="margin-right: 10px;">ğŸ“¦ åŠ æ¸›ç‰ˆæ•¸</label>
          <input type="number" id="manualPlates" value="" min="0" inputmode="numeric" autocomplete="off" style="width: 80px; height: 40px;" onwheel="return false;" onkeydown="return event.keyCode !== 38 && event.keyCode !== 40;">
        </div>
        <button class="btn btn-success" onclick="generateNotification()" ontouchstart="">ğŸ“¢ ç”Ÿæˆé€šå‘Šæ–‡å­—</button>
        <div class="notification-area" id="notificationArea" style="display:none;">
          <div id="notificationText"></div>
          <button class="btn btn-success" onclick="shareToWhatsApp()" ontouchstart="">ğŸ“² ç™¼é€åˆ° Whatsapp</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š å„²å­˜æ­·å²</div>
        <button class="btn btn-secondary" onclick="showCurrentDataDetails()" ontouchstart="" style="margin-bottom:15px;">ğŸ“‹ æŸ¥çœ‹ç•¶å‰æ•¸æ“šè©³æƒ…</button>
        <div class="saved-records-container" id="savedRecordsContainer">
          <p style="text-align:center;opacity:.7;">å°šç„¡å„²å­˜è¨˜éŒ„</p>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ æ‰€æœ‰è¨˜éŒ„</div>
        <div class="records-container" id="allRecords">
          <p style="text-align:center;opacity:.7;">å°šç„¡è¨˜éŒ„</p>
        </div>
        <button type="button" class="btn btn-danger" onclick="clearAllData()" ontouchstart="" style="margin-top:10px;">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰æ•¸æ“š</button>
      </div>
    </div>
  </div>

  <script>
    let baggingRecords=[],localData={weight:0,items:0,compressed:0},savedReports=[];

    function loadData(){
      // æ–°å¢ï¼šè‹¥ URL å¸¶æœ‰ ?reset=1ï¼Œå…ˆæ¸…ç©ºæœ¬åœ°å„²å­˜çš„æ•¸æ“š
      const params = new URLSearchParams(window.location.search);
      if (params.get('reset') === '1') {
        localStorage.removeItem('baggingRecords');
        localStorage.removeItem('localData');
      }

      baggingRecords=JSON.parse(localStorage.getItem('baggingRecords'))||[];
      localData=JSON.parse(localStorage.getItem('localData'))||{weight:0,items:0,compressed:0};
      savedReports=JSON.parse(localStorage.getItem('savedReports'))||[];
      renderLocalData();
      updateRecords();updateDashboard();
      renderSavedReports();
      populatePlateNumberSelect(); // æ–°å¢ï¼šè¼‰å…¥æ™‚å¡«å……ç‰ˆè™Ÿé¸æ“‡å™¨
    }
    function saveData(){
      localStorage.setItem('baggingRecords',JSON.stringify(baggingRecords));
      localStorage.setItem('localData',JSON.stringify(localData));
      localStorage.setItem('savedReports',JSON.stringify(savedReports));
    }
    function showTab(tabName,el){
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');el.classList.add('active');
      if(tabName==='dashboard')updateDashboard();
    }
    function calculateBagging(){
      const totalItems=parseInt(document.getElementById('totalItems').value)||0;
      const bagInputs=document.querySelectorAll('#bagInputs .bag-input');
      let bagsWithContent=0,totalBagItems=0;
      if(totalItems<0||Array.from(bagInputs).some(input=>parseInt(input.value)<0)){document.getElementById('baggingResult').textContent="è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼";return;}
      bagInputs.forEach(input=>{const val=parseInt(input.value)||0;if(val>0){bagsWithContent++;totalBagItems+=val;}});
      const remaining=totalItems-totalBagItems;
      document.getElementById('baggingResult').textContent=remaining+bagsWithContent;
    }
    function addMoreBags(){
      const c=document.getElementById('bagInputs');
      const idx=c.querySelectorAll('.bag-input').length+1;
      const input=document.createElement('input');
      input.type="number";input.className="bag-input";input.placeholder="è¢‹"+idx;input.min="0";
      input.setAttribute('inputmode','numeric');
      input.setAttribute('autocomplete','off');
      input.oninput=calculateBagging;c.appendChild(input);
    }
    function addBaggingRecord(){
      const plateNumberSelect=document.getElementById('plateNumber');
      const plateNumber=plateNumberSelect.value.trim();
      const weight=parseFloat(document.getElementById('weight').value)||0;
      const totalItems=parseInt(document.getElementById('totalItems').value)||0;
      if(!plateNumber||totalItems<=0){alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");return;}
      if(baggingRecords.some(r=>r.plateNumber===plateNumber)){alert("ç‰ˆè™Ÿå·²å­˜åœ¨");return;} // é›–ç„¶ä¸‹æ‹‰é¸å–®æœƒé¿å…ï¼Œä½†ä»ä¿ç•™æª¢æŸ¥
      if(weight<0){alert("é‡é‡ä¸èƒ½ç‚ºè² æ•¸");return;}
      const bagInputs=document.querySelectorAll('#bagInputs .bag-input');
      let bagsWithContent=0,totalBagItems=0;
      let bagDetails = []; // æ–°å¢ï¼šå„²å­˜æ¯å€‹è¢‹å­çš„è©³ç´°æ•¸é‡
      bagInputs.forEach((input, index)=>{
        const val=parseInt(input.value)||0;
        if(val>0){
          bagsWithContent++;
          totalBagItems+=val;
          bagDetails.push({bagNumber: index + 1, items: val}); // å„²å­˜è¢‹è™Ÿå’Œæ•¸é‡
        }
      });
      if(bagsWithContent===0){alert("è‡³å°‘è¼¸å…¥ä¸€è¢‹æ•¸æ“š");return;}
      const remaining=totalItems-totalBagItems;
      const finalResult=remaining+bagsWithContent;
      const record={
        plateNumber,
        weight,
        totalItems,
        bagsWithContent,
        totalBagItems,
        remaining,
        finalResult,
        compressedBags:finalResult,
        bagDetails: bagDetails, // æ–°å¢ï¼šä¿å­˜è¢‹å­è©³ç´°ä¿¡æ¯
        timestamp:new Date().toLocaleString('zh-HK')
      };
      baggingRecords.push(record);saveData();updateRecords();updateDashboard();clearCalculator();
      populatePlateNumberSelect(); // æ–°å¢ï¼šè¨˜éŒ„å¾Œæ›´æ–°ç‰ˆè™Ÿé¸æ“‡å™¨
    }
    function updateRecords(){
      const baggingHtml=baggingRecords.map(r=>`
        <div class="record-item">
          <div class="record-header"><span class="record-title">ğŸ“¦ ${r.plateNumber}</span><span>âš–ï¸ ${r.weight}kg</span></div>
          <div>ğŸ“Š ä»¶æ•¸: ${r.totalItems}ä»¶<br>ğŸ“¦ å£“ç¸®è¢‹: ${r.compressedBags}</div>
        </div>`).join('');

      const hasLocal = (Number(localData.items)||0)>0 || (Number(localData.weight)||0)>0 || (Number(localData.compressed)||0)>0;
      const localHtml = hasLocal ? `
        <div class="record-item" style="background:rgba(74,124,89,.2);border:1px solid rgba(144,238,144,.3);">
          <div class="record-header"><span class="record-title">ğŸ  æœ¬åœ°æ•¸æ“š</span></div>
          <div>âš–ï¸ é‡é‡: ${Number(localData.weight).toFixed(1)}kg<br>ğŸ“Š ä»¶æ•¸: ${localData.items}ä»¶<br>ğŸ“¦ å£“ç¸®è¢‹: ${localData.compressed}</div>
        </div>` : '';

      const combined = (baggingHtml + localHtml).trim();
      const emptyPlaceholder = '<p style="text-align:center;opacity:.7;">å°šç„¡è¨˜éŒ„</p>';
      document.getElementById('recordsList').innerHTML = combined || emptyPlaceholder;
      document.getElementById('allRecords').innerHTML = combined || emptyPlaceholder;
    }
    // æ–°å¢ï¼šåƒ…æ¸²æŸ“æœ¬åœ°æ•¸æ“šï¼Œä¸ä¿®æ”¹ localDataï¼ˆé¿å…è¼‰å…¥æ™‚è¢«æ¸…é›¶ï¼‰
    function renderLocalData(){
      const weightNum = Number(localData.weight)||0;
      const itemsNum = Number(localData.items)||0;
      const compressedNum = Number(localData.compressed)||0;
      // åŒæ­¥åˆ°è¼¸å…¥æ¡†ï¼Œå¦‚æœç‚º 0 å‰‡é¡¯ç¤ºç‚ºç©ºå­—ä¸²
      document.getElementById('localWeight').value = weightNum === 0 ? '' : weightNum;
      document.getElementById('localItems').value = itemsNum === 0 ? '' : itemsNum;
      document.getElementById('localCompressed').value = compressedNum === 0 ? '' : compressedNum;
      // åŒæ­¥åˆ°çµ±è¨ˆå±•ç¤º
      document.getElementById('localWeightDisplay').textContent = weightNum.toFixed(1);
      document.getElementById('localItemsDisplay').textContent = itemsNum;
      document.getElementById('localCompressedDisplay').textContent = compressedNum;
    }

    // æ¢å¾©ï¼šæ›´æ–°æœ¬åœ°æ•¸æ“šä¸¦åˆ·æ–°çµ±è¨ˆèˆ‡ç¸½çµï¼ˆä¾›è¼¸å…¥æ¡† oninput ä½¿ç”¨ï¼‰
    function updateLocalData(){
      const weight = parseFloat(document.getElementById('localWeight').value) || 0;
      const inputItems = document.getElementById('localItems').value.trim(); // ç²å–è¼¸å…¥æ¡†çš„å­—ä¸²å€¼
      const compressed = parseInt(document.getElementById('localCompressed').value) || 0;
      
      // é©—è­‰æ•¸å€¼æœ‰æ•ˆæ€§
      const parsedItems = parseInt(inputItems);
      if(weight < 0 || (!isNaN(parsedItems) && parsedItems < 0) || compressed < 0){
        alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼");
        return;
      }
      
      // å¦‚æœä»¶æ•¸æ²’æœ‰è¼¸å…¥ï¼ˆç‚ºç©ºå­—ä¸²ã€ç„¡æ•ˆæ•¸å­—ï¼‰ï¼Œå‰‡ç­‰åŒæ–¼å£“ç¸®æ•¸æ“š
      const items = (inputItems === '' || isNaN(parsedItems)) ? compressed : parsedItems;
      
      // ä¸»å‹•åœ¨è¼¸å…¥æ¡†ç‚ºç©ºæ™‚é¡¯ç¤ºæç¤ºæ–‡å­—ï¼ˆå¯é¸ï¼‰
      if(inputItems === '' && compressed > 0) {
        document.getElementById('localItems').placeholder = 'è‡ªå‹•ç­‰åŒå£“ç¸®æ•¸ (' + compressed + ')';
      } else {
        document.getElementById('localItems').placeholder = '';
      }
      
      localData.weight = weight;
      localData.items = items;
      localData.compressed = compressed;

      document.getElementById('localWeightDisplay').textContent = weight.toFixed(1);
      document.getElementById('localItemsDisplay').textContent = items;
      document.getElementById('localCompressedDisplay').textContent = compressed;

      updateDashboard();
      updateRecords();
    }

    function saveLocalData(){
      const weight = parseFloat(document.getElementById('localWeight').value) || 0;
      const compressed = parseInt(document.getElementById('localCompressed').value) || 0;
      
      // é©—è­‰å¿…é ˆè¼¸å…¥é …ç›®ï¼šé‡é‡å’Œå£“ç¸®
      if(weight <= 0) {
        alert("é‡é‡ç‚ºå¿…é ˆè¼¸å…¥é …ç›®ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼");
        document.getElementById('localWeight').focus();
        return;
      }
      
      if(compressed <= 0) {
        alert("å£“ç¸®ç‚ºå¿…é ˆè¼¸å…¥é …ç›®ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼");  
        document.getElementById('localCompressed').focus();
        return;
      }
      
      updateLocalData();
      saveData();
      alert("æœ¬åœ°æ•¸æ“šå·²ä¿å­˜");
    }
    function updateDashboard(){
      const totalPlates=baggingRecords.length;
      const totalItemsSum=baggingRecords.reduce((sum,r)=>sum+r.totalItems,0);
      const totalWeight=baggingRecords.reduce((sum,r)=>sum+r.weight,0);
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0);
      // document.getElementById('totalPlates').textContent=totalPlates;
      // document.getElementById('totalItemsSum').textContent=totalItemsSum;
      // document.getElementById('totalWeight').textContent=totalWeight.toFixed(1);
      // document.getElementById('totalCompressed').textContent=totalCompressed;
      const grandTotalItems=totalItemsSum+localData.items;
      const grandTotalWeight=(totalWeight+localData.weight).toFixed(1);
      const grandTotalCompressed=totalCompressed+localData.compressed;
      const grandTotalPlates=totalPlates+(parseInt(document.getElementById('manualPlates').value)||0);
      document.getElementById('grandTotalItems').textContent=grandTotalItems;
      document.getElementById('grandTotalWeight').textContent=grandTotalWeight;
      document.getElementById('grandTotalCompressed').textContent=grandTotalCompressed;
      document.getElementById('grandTotalPlates').textContent=grandTotalPlates;
    }
    function generateNotification(){
      const manualPlates=parseInt(document.getElementById('manualPlates').value)||0;
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0)+localData.compressed;
      const totalWeight=(baggingRecords.reduce((sum,r)=>sum+r.weight,0)+localData.weight).toFixed(1);
      const text=`æ—©æ™¨ï¼Œä»Šæ—¥å¯„${totalCompressed}è¢‹ï¼Œé‡${totalWeight}kgsï¼Œ${baggingRecords.length+manualPlates}ç‰ˆç¶“5Aè²¨æ«ƒç¢¼é ­ã€‚`;
      document.getElementById('notificationText').textContent=text;
      document.getElementById('notificationArea').style.display='block';
    }
    function copyToClipboard(){
      const text=document.getElementById('notificationText').textContent;
      const doAlert=()=>alert("é€šå‘Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿");
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(doAlert).catch(()=>{
            // Fallback 1: ä½¿ç”¨éš±è— textarea + execCommand
            const ta=document.createElement('textarea');
            ta.value=text; ta.setAttribute('readonly','');
            ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.opacity='0';
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try{ const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){doAlert();} else { throw new Error('execCommand failed'); } }
            catch(err){ document.body.removeChild(ta); window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text); }
          });
        } else {
          // Fallback 2: ç›´æ¥ä½¿ç”¨ execCommand
          const ta=document.createElement('textarea');
          ta.value=text; ta.setAttribute('readonly','');
          ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.opacity='0';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          try{ const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){doAlert();} else { throw new Error('execCommand failed'); } }
          catch(err){ document.body.removeChild(ta); window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text); }
        }
      }catch(e){
        // æœ€çµ‚å›é€€ï¼šæç¤ºæ‰‹å‹•è¤‡è£½
        window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text);
      }
    }
    function shareToWhatsApp(){
      const text=document.getElementById('notificationText').textContent;
      
      // æª¢æ¸¬æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      
      if (isMobile) {
        // ç§»å‹•è¨­å‚™ä½¿ç”¨ WhatsApp URL scheme
        const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(text)}`;
        const webWhatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        
        // é¦–å…ˆå˜—è©¦é–‹å•Ÿ WhatsApp æ‡‰ç”¨
        const link = document.createElement('a');
        link.href = whatsappUrl;
        link.target = '_blank';
        
        // å°æ–¼ iOSï¼Œå¦‚æœ WhatsApp æ‡‰ç”¨ç„¡æ³•é–‹å•Ÿï¼Œå‰‡å˜—è©¦ç¶²é ç‰ˆ
        if (isIOS) {
          try {
            // å˜—è©¦é–‹å•Ÿ WhatsApp æ‡‰ç”¨
            window.location.href = whatsappUrl;
            
            // å¦‚æœ 3 ç§’å¾Œé‚„åœ¨ç•¶å‰é é¢ï¼Œå‰‡é–‹å•Ÿç¶²é ç‰ˆ
            setTimeout(() => {
              if (!document.hidden) {
                window.open(webWhatsappUrl, '_blank');
              }
            }, 3000);
          } catch (e) {
            // å¦‚æœå‡ºéŒ¯ï¼Œç›´æ¥é–‹å•Ÿç¶²é ç‰ˆ
            window.open(webWhatsappUrl, '_blank');
          }
        } else {
          // Android è¨­å‚™
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // å‚™ç”¨æ–¹æ¡ˆï¼šç¶²é ç‰ˆ
          setTimeout(() => {
            window.open(webWhatsappUrl, '_blank');
          }, 1000);
        }
      } else {
        // æ¡Œé¢è¨­å‚™ä½¿ç”¨ç¶²é ç‰ˆ
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
      }
    }
    function clearCalculator(){
      document.getElementById('plateNumber').value=''; // æ¸…ç©ºé¸ä¸­çš„ç‰ˆè™Ÿ
      document.getElementById('weight').value='';
      document.getElementById('totalItems').value='';
      document.getElementById('bagInputs').innerHTML=`
        <input type="number" class="bag-input" placeholder="è¢‹1" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">
        <input type="number" class="bag-input" placeholder="è¢‹2" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">`;
      document.getElementById('baggingResult').textContent='0';
      populatePlateNumberSelect(); // æ–°å¢ï¼šæ¸…ç©ºå¾Œæ›´æ–°ç‰ˆè™Ÿé¸æ“‡å™¨
    }
    function showCustomConfirm(onYes){
      const overlay=document.getElementById('customConfirm');
      const yesBtn=document.getElementById('confirmYes');
      const noBtn=document.getElementById('confirmNo');
      const cleanup=()=>{
        overlay.style.display='none';
        overlay.setAttribute('aria-hidden','true');
        yesBtn.onclick=null; noBtn.onclick=null;
      };
      yesBtn.onclick=()=>{cleanup();onYes&&onYes();};
      noBtn.onclick=cleanup;
      overlay.style.display='flex';
      overlay.setAttribute('aria-hidden','false');
    }

    function clearAllData(){
      showCustomConfirm(()=>{
        // 1. æ¸…ç©ºè¨˜æ†¶é«”è®Šæ•¸
        baggingRecords=[];
        localData={weight:0,items:0,compressed:0};
        savedReports=[];
        
        // 2. æ¸…ç©º localStorage
        localStorage.removeItem('baggingRecords');
        localStorage.removeItem('localData');
        localStorage.removeItem('savedReports');
        
        // 3. æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
        document.getElementById('plateNumber').value='';
        document.getElementById('weight').value='';
        document.getElementById('totalItems').value='';
        document.getElementById('bagInputs').innerHTML=`
          <input type="number" class="bag-input" placeholder="è¢‹1" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">
          <input type="number" class="bag-input" placeholder="è¢‹2" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">`;
        document.getElementById('baggingResult').textContent='0';
        
        // 4. æ¸…ç©ºæœ¬åœ°æ•¸æ“šè¼¸å…¥æ¬„ä½
        document.getElementById('localWeight').value='';
        document.getElementById('localItems').value='';
        document.getElementById('localCompressed').value='';
        document.getElementById('manualPlates').value='0';
        
        // 5. é‡ç½®çµ±è¨ˆé¡¯ç¤º
        document.getElementById('localWeightDisplay').textContent='0.0';
        document.getElementById('localItemsDisplay').textContent='0';
        document.getElementById('localCompressedDisplay').textContent='0';
        
        // 6. æ›´æ–°æ‰€æœ‰é¡¯ç¤º
        renderLocalData();
        updateRecords();
        updateDashboard();
        renderSavedReports();
        populatePlateNumberSelect();
        
        // 7. éš±è—é€šå‘Šå€åŸŸ
        document.getElementById('notificationArea').style.display='none';
        
        alert("æ‰€æœ‰æ•¸æ“šå·²å®Œå…¨æ¸…ç©º");
      });
    }

    function saveAndGenerateNotification(){
      // å…ˆç”Ÿæˆé€šå‘Š
      generateNotification();
      
      // æ”¶é›†ç•¶å‰æ•¸æ“š
      const currentDate = new Date().toLocaleDateString('zh-HK', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        weekday: 'short'
      });
      
      const manualPlates=parseInt(document.getElementById('manualPlates').value)||0;
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0)+localData.compressed;
      const totalWeight=(baggingRecords.reduce((sum,r)=>sum+r.weight,0)+localData.weight).toFixed(1);
      const totalPlates=baggingRecords.length+manualPlates;
      const totalItems=baggingRecords.reduce((sum,r)=>sum+r.totalItems,0)+localData.items;
      
      // æ·»åŠ èª¿è©¦ä¿¡æ¯
      console.log('å„²å­˜å‰æ•¸æ“šç‹€æ…‹:', {
        baggingRecordsCount: baggingRecords.length,
        baggingRecords: baggingRecords,
        localData: localData,
        localDataExists: (localData.weight > 0 || localData.items > 0 || localData.compressed > 0)
      });
      
      // å‰µå»ºå ±å‘Šè¨˜éŒ„ - ä½¿ç”¨æ·±è¤‡è£½ç¢ºä¿æ•¸æ“šå®Œæ•´æ€§
      const report = {
        date: currentDate,
        timestamp: new Date().toLocaleString('zh-HK'),
        totalPlates: totalPlates,
        totalWeight: parseFloat(totalWeight),
        totalCompressed: totalCompressed,
        totalItems: totalItems,
        baggingRecords: JSON.parse(JSON.stringify(baggingRecords)), // æ·±è¤‡è£½å…¥è¢‹è¨˜éŒ„
        localData: JSON.parse(JSON.stringify(localData)), // æ·±è¤‡è£½æœ¬åœ°æ•¸æ“š
        manualPlates: manualPlates,
        notificationText: document.getElementById('notificationText').textContent
      };
      
      // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
      console.log('å³å°‡å„²å­˜çš„å ±å‘Š:', report);
      
      // æ·»åŠ åˆ°å„²å­˜åˆ—è¡¨
      savedReports.unshift(report); // æ·»åŠ åˆ°é–‹é ­ï¼Œæœ€æ–°çš„åœ¨å‰é¢
      
      // é™åˆ¶å„²å­˜è¨˜éŒ„æ•¸é‡ï¼ˆä¾‹å¦‚æœ€å¤šä¿å­˜50æ¢ï¼‰
      if(savedReports.length > 50) {
        savedReports = savedReports.slice(0, 50);
      }
      
      // ä¿å­˜æ•¸æ“š
      saveData();
      
      // æ›´æ–°é¡¯ç¤º
      renderSavedReports();
      
      alert('æ•¸æ“šå·²å„²å­˜ï¼åŒ…å« ' + baggingRecords.length + ' ç‰ˆè©³ç´°è¨˜éŒ„å’Œæœ¬åœ°æ•¸æ“š');
    }

    function renderSavedReports(){
      const container = document.getElementById('savedRecordsContainer');
      
      if(savedReports.length === 0) {
        container.innerHTML = '<p style="text-align:center;opacity:.7;">å°šç„¡å„²å­˜è¨˜éŒ„</p>';
        return;
      }
      
      let html = '';
      savedReports.forEach((report, index) => {
        // å‰µå»ºæ¯ç‰ˆè©³ç´°æ•¸æ“šè¡¨æ ¼
        let baggingDetailsHtml = '';
        if(report.baggingRecords && report.baggingRecords.length > 0) {
          baggingDetailsHtml = `
            <div class="detail-section-title">ğŸ“¦ æ¯ç‰ˆè©³ç´°è³‡æ–™ (${report.baggingRecords.length} ç‰ˆ)</div>
            <table class="saved-record-table">
              <thead>
                <tr>
                  <th>ç‰ˆè™Ÿ</th>
                  <th>é‡é‡ (kg)</th>
                  <th>ç¸½ä»¶æ•¸</th>
                  <th>å…¥è¢‹è©³æƒ…</th>
                  <th>å£“ç¸®çµæœ</th>
                </tr>
              </thead>
              <tbody>
                ${report.baggingRecords.map(record => {
                  // å‰µå»ºè¢‹å­è©³ç´°ä¿¡æ¯å­—ä¸²
                  let bagDetailsStr = '';
                  if(record.bagDetails && record.bagDetails.length > 0) {
                    bagDetailsStr = record.bagDetails.map(bag => `è¢‹${bag.bagNumber}: ${bag.items}ä»¶`).join('<br>');
                  } else {
                    // å¦‚æœæ²’æœ‰bagDetailsï¼Œé¡¯ç¤ºç¸½è¢‹æ•¸
                    bagDetailsStr = `${record.bagsWithContent || 0}è¢‹`;
                  }
                  
                  return `
                    <tr>
                      <td><strong>${record.plateNumber}</strong></td>
                      <td>${record.weight}</td>
                      <td>${record.totalItems}</td>
                      <td style="font-size:12px;line-height:1.4;">${bagDetailsStr}</td>
                      <td><strong>${record.compressedBags}</strong></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        } else {
          // å¦‚æœæ²’æœ‰æ¯ç‰ˆè©³ç´°æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
          baggingDetailsHtml = `
            <div class="detail-section-title">ğŸ“¦ æ¯ç‰ˆè©³ç´°è³‡æ–™</div>
            <div style="padding:15px;text-align:center;color:#888;background:rgba(0,0,0,0.2);border-radius:8px;">
              æ²’æœ‰å„²å­˜æ¯ç‰ˆçš„è©³ç´°è³‡æ–™
            </div>
          `;
        }
        
        // å‰µå»ºæœ¬åœ°æ•¸æ“šè©³ç´°è¡¨æ ¼
        let localDetailsHtml = '';
        const hasLocalData = report.localData && (report.localData.weight > 0 || report.localData.items > 0 || report.localData.compressed > 0);
        if(hasLocalData) {
          localDetailsHtml = `
            <div class="detail-section-title">ğŸ  æœ¬åœ°æ•¸æ“šè©³ç´°</div>
            <table class="saved-record-table">
              <thead>
                <tr>
                  <th>é¡å‹</th>
                  <th>é‡é‡ (kg)</th>
                  <th>ç¸½ä»¶æ•¸</th>
                  <th>å£“ç¸®çµæœ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>æœ¬åœ°è²¨</strong></td>
                  <td>${report.localData.weight}</td>
                  <td>${report.localData.items}</td>
                  <td><strong>${report.localData.compressed}</strong></td>
                </tr>
              </tbody>
            </table>
          `;
        } else {
          // å¦‚æœæ²’æœ‰æœ¬åœ°æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
          localDetailsHtml = `
            <div class="detail-section-title">ğŸ  æœ¬åœ°æ•¸æ“šè©³ç´°</div>
            <div style="padding:15px;text-align:center;color:#888;background:rgba(0,0,0,0.2);border-radius:8px;">
              æ²’æœ‰å„²å­˜æœ¬åœ°æ•¸æ“š
            </div>
          `;
        }
        
        // æ‰‹å‹•ç‰ˆæ•¸èªªæ˜
        let manualPlatesHtml = '';
        if(report.manualPlates && report.manualPlates > 0) {
          manualPlatesHtml = `
            <div class="manual-plates-info">
              <strong>ğŸ“ æ‰‹å‹•åŠ æ¸›ç‰ˆæ•¸ï¼š</strong> <span style="color:#90EE90;font-weight:bold;">+${report.manualPlates} ç‰ˆ</span>
            </div>
          `;
        }
        
        html += `
          <div class="saved-record-item">
            <div class="saved-record-date">ğŸ“… ${report.date} - ${report.timestamp}</div>
            
            <!-- ç¸½çµè¡¨æ ¼ -->
            <div class="detail-section-title">ğŸ“Š ç¸½çµè³‡æ–™</div>
            <table class="saved-record-table">
              <thead>
                <tr>
                  <th>ç¸½ç‰ˆæ•¸</th>
                  <th>ç¸½é‡é‡ (kg)</th>
                  <th>ç¸½ä»¶æ•¸</th>
                  <th>ç¸½å£“ç¸®è¢‹</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>${report.totalPlates}</strong></td>
                  <td><strong>${report.totalWeight}</strong></td>
                  <td><strong>${report.totalItems}</strong></td>
                  <td><strong>${report.totalCompressed}</strong></td>
                </tr>
              </tbody>
            </table>
            
            ${baggingDetailsHtml}
            ${localDetailsHtml}
            ${manualPlatesHtml}
            
            <div class="notification-text-container">
              <strong>ğŸ“¢ é€šå‘Šæ–‡å­—ï¼š</strong><br>
              <span style="color:#90EE90;font-size:14px;line-height:1.4;">${report.notificationText}</span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // æ–°å¢ï¼šå¡«å……ç‰ˆè™Ÿé¸æ“‡å™¨å‡½æ•¸
    function populatePlateNumberSelect() {
      const selectElement = document.getElementById('plateNumber');
      selectElement.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

      const usedPlateNumbers = new Set(baggingRecords.map(r => r.plateNumber));
      const startNumber = 1;
      const endNumber = 999; // å‡è¨­ç‰ˆè™Ÿç¯„åœç‚º 1 åˆ° 999ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´

      let hasAvailablePlate = false;

      for (let i = startNumber; i <= endNumber; i++) {
        const plateNum = String(i); // å–®ç´”çš„æ•¸å­—ç‰ˆè™Ÿ
        if (!usedPlateNumbers.has(plateNum)) {
          const option = document.createElement('option');
          option.value = plateNum;
          option.textContent = plateNum;
          selectElement.appendChild(option);
          hasAvailablePlate = true;
        }
      }

      if (!hasAvailablePlate) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ç„¡å¯ç”¨ç‰ˆè™Ÿ';
        option.disabled = true;
        selectElement.appendChild(option);
        selectElement.value = ''; // ç¢ºä¿æ²’æœ‰é¸ä¸­ä»»ä½•å€¼
      } else {
        // å¦‚æœæœ‰å¯ç”¨ç‰ˆè™Ÿï¼Œé è¨­é¸ä¸­ç¬¬ä¸€å€‹
        selectElement.selectedIndex = 0;
      }
    }

    function showCurrentDataDetails(){
      const container = document.getElementById('savedRecordsContainer');
      
      // ç›´æ¥ä½¿ç”¨ç•¶å‰çš„ baggingRecords å’Œ localData
      let detailsHtml = `
        <div class="saved-record-item">
          <div class="saved-record-date">ğŸ“… ç•¶å‰æ•¸æ“šè©³æƒ… - ${new Date().toLocaleString('zh-HK')}</div>
      `;
      
      // ç•¶å‰ç¸½çµ
      const currentTotalWeight = (baggingRecords.reduce((sum,r)=>sum+r.weight,0)+localData.weight).toFixed(1);
      const currentTotalItems = baggingRecords.reduce((sum,r)=>sum+r.totalItems,0)+localData.items;
      const currentTotalCompressed = baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0)+localData.compressed;
      const currentTotalPlates = baggingRecords.length;
      
      detailsHtml += `
          <!-- ç•¶å‰ç¸½çµ -->
          <div class="detail-section-title">ğŸ“Š ç•¶å‰ç¸½çµ</div>
          <table class="saved-record-table">
            <thead>
              <tr>
                <th>ç‰ˆæ•¸</th>
                <th>ç¸½é‡é‡ (kg)</th>
                <th>ç¸½ä»¶æ•¸</th>
                <th>ç¸½å£“ç¸®è¢‹</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>${currentTotalPlates}</strong></td>
                <td><strong>${currentTotalWeight}</strong></td>
                <td><strong>${currentTotalItems}</strong></td>
                <td><strong>${currentTotalCompressed}</strong></td>
              </tr>
            </tbody>
          </table>
      `;
      
      // å…¥è¢‹è¨˜éŒ„è©³æƒ…
      if(baggingRecords && baggingRecords.length > 0) {
        detailsHtml += `
          <div class="detail-section-title">ğŸ“¦ å…¥è¢‹è¨˜éŒ„è©³æƒ… (${baggingRecords.length} ç‰ˆ)</div>
          <table class="saved-record-table">
            <thead>
              <tr>
                <th>ç‰ˆè™Ÿ</th>
                <th>é‡é‡ (kg)</th>
                <th>ç¸½ä»¶æ•¸</th>
                <th>å…¥è¢‹è©³æƒ…</th>
                <th>å£“ç¸®çµæœ</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        baggingRecords.forEach(record => {
          // å‰µå»ºè¢‹å­è©³ç´°ä¿¡æ¯å­—ä¸²
          let bagDetailsStr = '';
          if(record.bagDetails && record.bagDetails.length > 0) {
            bagDetailsStr = record.bagDetails.map(bag => `è¢‹${bag.bagNumber}: ${bag.items}ä»¶`).join('<br>');
          } else {
            // å¦‚æœæ²’æœ‰bagDetailsï¼Œé¡¯ç¤ºç¸½è¢‹æ•¸
            bagDetailsStr = `${record.bagsWithContent || 0}è¢‹`;
          }
          
          detailsHtml += `
              <tr>
                <td><strong>${record.plateNumber}</strong></td>
                <td>${record.weight}</td>
                <td>${record.totalItems}</td>
                <td style="font-size:12px;line-height:1.4;">${bagDetailsStr}</td>
                <td><strong>${record.compressedBags}</strong></td>
              </tr>
          `;
        });
        
        detailsHtml += `
            </tbody>
          </table>
        `;
      } else {
        detailsHtml += `
          <div class="detail-section-title">ğŸ“¦ å…¥è¢‹è¨˜éŒ„è©³æƒ…</div>
          <div style="padding:15px;text-align:center;color:#888;background:rgba(0,0,0,0.2);border-radius:8px;">
            ç•¶å‰æ²’æœ‰å…¥è¢‹è¨˜éŒ„
          </div>
        `;
      }
      
      // æœ¬åœ°æ•¸æ“šè©³æƒ…
      const hasLocalData = (localData.weight > 0 || localData.items > 0 || localData.compressed > 0);
      if(hasLocalData) {
        detailsHtml += `
          <div class="detail-section-title">ğŸ  æœ¬åœ°æ•¸æ“šè©³æƒ…</div>
          <table class="saved-record-table">
            <thead>
              <tr>
                <th>é¡å‹</th>
                <th>é‡é‡ (kg)</th>
                <th>ç¸½ä»¶æ•¸</th>
                <th>å£“ç¸®çµæœ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>æœ¬åœ°è²¨</strong></td>
                <td>${localData.weight}</td>
                <td>${localData.items}</td>
                <td><strong>${localData.compressed}</strong></td>
              </tr>
            </tbody>
          </table>
        `;
      } else {
        detailsHtml += `
          <div class="detail-section-title">ğŸ  æœ¬åœ°æ•¸æ“šè©³æƒ…</div>
          <div style="padding:15px;text-align:center;color:#888;background:rgba(0,0,0,0.2);border-radius:8px;">
            ç•¶å‰æ²’æœ‰æœ¬åœ°æ•¸æ“š
          </div>
        `;
      }
      
      detailsHtml += `
        </div>
      `;
      
      container.innerHTML = detailsHtml;
    }

    window.onload=loadData;
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
    function showTab(tabName,el){
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');el.classList.add('active');
      if(tabName==='dashboard')updateDashboard();
    }
    function calculateBagging(){
      const totalItems=parseInt(document.getElementById('totalItems').value)||0;
      const bagInputs=document.querySelectorAll('#bagInputs .bag-input');
      let bagsWithContent=0,totalBagItems=0;
      if(totalItems<0||Array.from(bagInputs).some(input=>parseInt(input.value)<0)){document.getElementById('baggingResult').textContent="è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼";return;}
      bagInputs.forEach(input=>{const val=parseInt(input.value)||0;if(val>0){bagsWithContent++;totalBagItems+=val;}});
      const remaining=totalItems-totalBagItems;
      document.getElementById('baggingResult').textContent=remaining+bagsWithContent;
    }
    function addMoreBags(){
      const c=document.getElementById('bagInputs');
      const idx=c.querySelectorAll('.bag-input').length+1;
      const input=document.createElement('input');
      input.type="number";input.className="bag-input";input.placeholder="è¢‹"+idx;input.min="0";
      input.setAttribute('inputmode','numeric');
      input.setAttribute('autocomplete','off');
      input.oninput=calculateBagging;c.appendChild(input);
    }
    function addBaggingRecord(){
      const plateNumberSelect=document.getElementById('plateNumber');
      const plateNumber=plateNumberSelect.value.trim();
      const weight=parseFloat(document.getElementById('weight').value)||0;
      const totalItems=parseInt(document.getElementById('totalItems').value)||0;
      if(!plateNumber||totalItems<=0){alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");return;}
      if(baggingRecords.some(r=>r.plateNumber===plateNumber)){alert("ç‰ˆè™Ÿå·²å­˜åœ¨");return;} // é›–ç„¶ä¸‹æ‹‰é¸å–®æœƒé¿å…ï¼Œä½†ä»ä¿ç•™æª¢æŸ¥
      if(weight<0){alert("é‡é‡ä¸èƒ½ç‚ºè² æ•¸");return;}
      const bagInputs=document.querySelectorAll('#bagInputs .bag-input');
      let bagsWithContent=0,totalBagItems=0;
      bagInputs.forEach(input=>{const val=parseInt(input.value)||0;if(val>0){bagsWithContent++;totalBagItems+=val;}});
      if(bagsWithContent===0){alert("è‡³å°‘è¼¸å…¥ä¸€è¢‹æ•¸æ“š");return;}
      const remaining=totalItems-totalBagItems;
      const finalResult=remaining+bagsWithContent;
      const record={plateNumber,weight,totalItems,bagsWithContent,totalBagItems,remaining,finalResult,compressedBags:finalResult,timestamp:new Date().toLocaleString('zh-HK')};
      baggingRecords.push(record);saveData();updateRecords();updateDashboard();clearCalculator();
      populatePlateNumberSelect(); // æ–°å¢ï¼šè¨˜éŒ„å¾Œæ›´æ–°ç‰ˆè™Ÿé¸æ“‡å™¨
    }
    function updateRecords(){
      const baggingHtml=baggingRecords.map(r=>`
        <div class="record-item">
          <div class="record-header"><span class="record-title">ğŸ“¦ ${r.plateNumber}</span><span>âš–ï¸ ${r.weight}kg</span></div>
          <div>ğŸ“Š ä»¶æ•¸: ${r.totalItems}ä»¶<br>ğŸ“¦ å£“ç¸®è¢‹: ${r.compressedBags}</div>
        </div>`).join('');

      const hasLocal = (Number(localData.items)||0)>0 || (Number(localData.weight)||0)>0 || (Number(localData.compressed)||0)>0;
      const localHtml = hasLocal ? `
        <div class="record-item" style="background:rgba(74,124,89,.2);border:1px solid rgba(144,238,144,.3);">
          <div class="record-header"><span class="record-title">ğŸ  æœ¬åœ°æ•¸æ“š</span></div>
          <div>âš–ï¸ é‡é‡: ${Number(localData.weight).toFixed(1)}kg<br>ğŸ“Š ä»¶æ•¸: ${localData.items}ä»¶<br>ğŸ“¦ å£“ç¸®è¢‹: ${localData.compressed}</div>
        </div>` : '';

      const combined = (baggingHtml + localHtml).trim();
      const emptyPlaceholder = '<p style="text-align:center;opacity:.7;">å°šç„¡è¨˜éŒ„</p>';
      document.getElementById('recordsList').innerHTML = combined || emptyPlaceholder;
      document.getElementById('allRecords').innerHTML = combined || emptyPlaceholder;
    }
    // æ–°å¢ï¼šåƒ…æ¸²æŸ“æœ¬åœ°æ•¸æ“šï¼Œä¸ä¿®æ”¹ localDataï¼ˆé¿å…è¼‰å…¥æ™‚è¢«æ¸…é›¶ï¼‰
    function renderLocalData(){
      const weightNum = Number(localData.weight)||0;
      const itemsNum = Number(localData.items)||0;
      const compressedNum = Number(localData.compressed)||0;
      
      // åŒæ­¥åˆ°è¼¸å…¥æ¡†ï¼Œå¦‚æœç‚º 0 å‰‡é¡¯ç¤ºç‚ºç©ºå­—ä¸²
      document.getElementById('localWeight').value = weightNum === 0 ? '' : weightNum;
      // ä»¶æ•¸ç‰¹æ®Šè™•ç†ï¼šå¦‚æœä»¶æ•¸ç‚º0ä½†å£“ç¸®å¤§æ–¼0ï¼Œå‰‡ä»¶æ•¸é¡¯ç¤ºç‚ºç©ºä½†çµ±è¨ˆå€é¡¯ç¤ºå£“ç¸®å€¼
      if(itemsNum === 0 && compressedNum > 0) {
        document.getElementById('localItems').value = ''; // è¼¸å…¥æ¡†ç‚ºç©º
        document.getElementById('localItemsDisplay').textContent = compressedNum; // çµ±è¨ˆå€é¡¯ç¤ºå£“ç¸®å€¼
        localData.items = compressedNum; // æ›´æ–°å¯¦éš›æ•¸æ“š
      } else {
        document.getElementById('localItems').value = itemsNum === 0 ? '' : itemsNum;
        document.getElementById('localItemsDisplay').textContent = itemsNum;
      }
      
      document.getElementById('localCompressed').value = compressedNum === 0 ? '' : compressedNum;
      // åŒæ­¥åˆ°çµ±è¨ˆå±•ç¤º
      document.getElementById('localWeightDisplay').textContent = weightNum.toFixed(1);
      document.getElementById('localCompressedDisplay').textContent = compressedNum;
    }

    function saveLocalData(){
      const weight = parseFloat(document.getElementById('localWeight').value) || 0;
      const compressed = parseInt(document.getElementById('localCompressed').value) || 0;
      
      // é©—è­‰å¿…é ˆè¼¸å…¥é …ç›®ï¼šé‡é‡å’Œå£“ç¸®
      if(weight <= 0) {
        alert("é‡é‡ç‚ºå¿…é ˆè¼¸å…¥é …ç›®ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼");
        document.getElementById('localWeight').focus();
        return;
      }
      
      if(compressed <= 0) {
        alert("å£“ç¸®ç‚ºå¿…é ˆè¼¸å…¥é …ç›®ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼");  
        document.getElementById('localCompressed').focus();
        return;
      }
      
      updateLocalData();
      saveData();
      alert("æœ¬åœ°æ•¸æ“šå·²ä¿å­˜");
    }
    function updateDashboard(){
      const totalPlates=baggingRecords.length;
      const totalItemsSum=baggingRecords.reduce((sum,r)=>sum+r.totalItems,0);
      const totalWeight=baggingRecords.reduce((sum,r)=>sum+r.weight,0);
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0);
      // document.getElementById('totalPlates').textContent=totalPlates;
      // document.getElementById('totalItemsSum').textContent=totalItemsSum;
      // document.getElementById('totalWeight').textContent=totalWeight.toFixed(1);
      // document.getElementById('totalCompressed').textContent=totalCompressed;
      const grandTotalItems=totalItemsSum+localData.items;
      const grandTotalWeight=(totalWeight+localData.weight).toFixed(1);
      const grandTotalCompressed=totalCompressed+localData.compressed;
      const grandTotalPlates=totalPlates+(parseInt(document.getElementById('manualPlates').value)||0);
      document.getElementById('grandTotalItems').textContent=grandTotalItems;
      document.getElementById('grandTotalWeight').textContent=grandTotalWeight;
      document.getElementById('grandTotalCompressed').textContent=grandTotalCompressed;
      document.getElementById('grandTotalPlates').textContent=grandTotalPlates;
    }
    function generateNotification(){
      const manualPlates=parseInt(document.getElementById('manualPlates').value)||0;
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0)+localData.compressed;
      const totalWeight=(baggingRecords.reduce((sum,r)=>sum+r.weight,0)+localData.weight).toFixed(1);
      const text=`æ—©æ™¨ï¼Œä»Šæ—¥å¯„${totalCompressed}è¢‹ï¼Œé‡${totalWeight}kgsï¼Œ${baggingRecords.length+manualPlates}ç‰ˆç¶“5Aè²¨æ«ƒç¢¼é ­ã€‚`;
      document.getElementById('notificationText').textContent=text;
      document.getElementById('notificationArea').style.display='block';
    }
    function copyToClipboard(){
      const text=document.getElementById('notificationText').textContent;
      const doAlert=()=>alert("é€šå‘Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿");
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(doAlert).catch(()=>{
            // Fallback 1: ä½¿ç”¨éš±è— textarea + execCommand
            const ta=document.createElement('textarea');
            ta.value=text; ta.setAttribute('readonly','');
            ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.opacity='0';
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try{ const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){doAlert();} else { throw new Error('execCommand failed'); } }
            catch(err){ document.body.removeChild(ta); window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text); }
          });
        } else {
          // Fallback 2: ç›´æ¥ä½¿ç”¨ execCommand
          const ta=document.createElement('textarea');
          ta.value=text; ta.setAttribute('readonly','');
          ta.style.position='fixed'; ta.style.top='0'; ta.style.left='0'; ta.style.opacity='0';
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          try{ const ok=document.execCommand('copy'); document.body.removeChild(ta); if(ok){doAlert();} else { throw new Error('execCommand failed'); } }
          catch(err){ document.body.removeChild(ta); window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text); }
        }
      }catch(e){
        // æœ€çµ‚å›é€€ï¼šæç¤ºæ‰‹å‹•è¤‡è£½
        window.prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', text);
      }
    }
    function shareToWhatsApp(){
      const text=document.getElementById('notificationText').textContent;
      
      // æª¢æ¸¬æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      
      if (isMobile) {
        // ç§»å‹•è¨­å‚™ä½¿ç”¨ WhatsApp URL scheme
        const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(text)}`;
        const webWhatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        
        // é¦–å…ˆå˜—è©¦é–‹å•Ÿ WhatsApp æ‡‰ç”¨
        const link = document.createElement('a');
        link.href = whatsappUrl;
        link.target = '_blank';
        
        // å°æ–¼ iOSï¼Œå¦‚æœ WhatsApp æ‡‰ç”¨ç„¡æ³•é–‹å•Ÿï¼Œå‰‡å˜—è©¦ç¶²é ç‰ˆ
        if (isIOS) {
          try {
            // å˜—è©¦é–‹å•Ÿ WhatsApp æ‡‰ç”¨
            window.location.href = whatsappUrl;
            
            // å¦‚æœ 3 ç§’å¾Œé‚„åœ¨ç•¶å‰é é¢ï¼Œå‰‡é–‹å•Ÿç¶²é ç‰ˆ
            setTimeout(() => {
              if (!document.hidden) {
                window.open(webWhatsappUrl, '_blank');
              }
            }, 3000);
          } catch (e) {
            // å¦‚æœå‡ºéŒ¯ï¼Œç›´æ¥é–‹å•Ÿç¶²é ç‰ˆ
            window.open(webWhatsappUrl, '_blank');
          }
        } else {
          // Android è¨­å‚™
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // å‚™ç”¨æ–¹æ¡ˆï¼šç¶²é ç‰ˆ
          setTimeout(() => {
            window.open(webWhatsappUrl, '_blank');
          }, 1000);
        }
      } else {
        // æ¡Œé¢è¨­å‚™ä½¿ç”¨ç¶²é ç‰ˆ
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
      }
    }
    function clearCalculator(){
      document.getElementById('plateNumber').value=''; // æ¸…ç©ºé¸ä¸­çš„ç‰ˆè™Ÿ
      document.getElementById('weight').value='';
      document.getElementById('totalItems').value='';
      document.getElementById('bagInputs').innerHTML=`
        <input type="number" class="bag-input" placeholder="è¢‹1" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">
        <input type="number" class="bag-input" placeholder="è¢‹2" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">`;
      document.getElementById('baggingResult').textContent='0';
      populatePlateNumberSelect(); // æ–°å¢ï¼šæ¸…ç©ºå¾Œæ›´æ–°ç‰ˆè™Ÿé¸æ“‡å™¨
    }
    function showCustomConfirm(onYes){
      const overlay=document.getElementById('customConfirm');
      const yesBtn=document.getElementById('confirmYes');
      const noBtn=document.getElementById('confirmNo');
      const cleanup=()=>{
        overlay.style.display='none';
        overlay.setAttribute('aria-hidden','true');
        yesBtn.onclick=null; noBtn.onclick=null;
      };
      yesBtn.onclick=()=>{cleanup();onYes&&onYes();};
      noBtn.onclick=cleanup;
      overlay.style.display='flex';
      overlay.setAttribute('aria-hidden','false');
    }

    function clearAllData(){
      showCustomConfirm(()=>{
        // 1. æ¸…ç©ºè¨˜æ†¶é«”è®Šæ•¸
        baggingRecords=[];
        localData={weight:0,items:0,compressed:0};
        savedReports=[];
        
        // 2. æ¸…ç©º localStorage
        localStorage.removeItem('baggingRecords');
        localStorage.removeItem('localData');
        localStorage.removeItem('savedReports');
        
        // 3. æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
        document.getElementById('plateNumber').value='';
        document.getElementById('weight').value='';
        document.getElementById('totalItems').value='';
        document.getElementById('bagInputs').innerHTML=`
          <input type="number" class="bag-input" placeholder="è¢‹1" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">
          <input type="number" class="bag-input" placeholder="è¢‹2" inputmode="numeric" autocomplete="off" oninput="calculateBagging()" min="0">`;
        document.getElementById('baggingResult').textContent='0';
        
        // 4. æ¸…ç©ºæœ¬åœ°æ•¸æ“šè¼¸å…¥æ¬„ä½
        document.getElementById('localWeight').value='';
        document.getElementById('localItems').value='';
        document.getElementById('localCompressed').value='';
        document.getElementById('manualPlates').value='0';
        
        // 5. é‡ç½®çµ±è¨ˆé¡¯ç¤º
        document.getElementById('localWeightDisplay').textContent='0.0';
        document.getElementById('localItemsDisplay').textContent='0';
        document.getElementById('localCompressedDisplay').textContent='0';
        
        // 6. æ›´æ–°æ‰€æœ‰é¡¯ç¤º
        renderLocalData();
        updateRecords();
        updateDashboard();
        renderSavedReports();
        populatePlateNumberSelect();
        
        // 7. éš±è—é€šå‘Šå€åŸŸ
        document.getElementById('notificationArea').style.display='none';
        
        alert("æ‰€æœ‰æ•¸æ“šå·²å®Œå…¨æ¸…ç©º");
      });
    }

    function saveAndGenerateNotification(){
      // å…ˆç”Ÿæˆé€šå‘Š
      generateNotification();
      
      // æ”¶é›†ç•¶å‰æ•¸æ“š
      const currentDate = new Date().toLocaleDateString('zh-HK', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        weekday: 'short'
      });
      
      const manualPlates=parseInt(document.getElementById('manualPlates').value)||0;
      const totalCompressed=baggingRecords.reduce((sum,r)=>sum+r.compressedBags,0)+localData.compressed;
      const totalWeight=(baggingRecords.reduce((sum,r)=>sum+r.weight,0)+localData.weight).toFixed(1);
      const totalPlates=baggingRecords.length+manualPlates;
      const totalItems=baggingRecords.reduce((sum,r)=>sum+r.totalItems,0)+localData.items;
      
      // æ·»åŠ èª¿è©¦ä¿¡æ¯
      console.log('å„²å­˜å‰æ•¸æ“šç‹€æ…‹:', {
        baggingRecordsCount: baggingRecords.length,
        baggingRecords: baggingRecords,
        localData: localData,
        localDataExists: (localData.weight > 0 || localData.items > 0 || localData.compressed > 0)
      });
      
      // å‰µå»ºå ±å‘Šè¨˜éŒ„ - ä½¿ç”¨æ·±è¤‡è£½ç¢ºä¿æ•¸æ“šå®Œæ•´æ€§
      const report = {
        date: currentDate,
        timestamp: new Date().toLocaleString('zh-HK'),
        totalPlates: totalPlates,
        totalWeight: parseFloat(totalWeight),
        totalCompressed: totalCompressed,
        totalItems: totalItems,
        baggingRecords: JSON.parse(JSON.stringify(baggingRecords)), // æ·±è¤‡è£½å…¥è¢‹è¨˜éŒ„
        localData: JSON.parse(JSON.stringify(localData)), // æ·±è¤‡è£½æœ¬åœ°æ•¸æ“š
        manualPlates: manualPlates,
        notificationText: document.getElementById('notificationText').textContent
      };
      
      // é©—è­‰æ•¸æ“šå®Œæ•´æ€§
      console.log('å³å°‡å„²å­˜çš„å ±å‘Š:', report);
      
      // æ·»åŠ åˆ°å„²å­˜åˆ—è¡¨
      savedReports.unshift(report); // æ·»åŠ åˆ°é–‹é ­ï¼Œæœ€æ–°çš„åœ¨å‰é¢
      
      // é™åˆ¶å„²å­˜è¨˜éŒ„æ•¸é‡ï¼ˆä¾‹å¦‚æœ€å¤šä¿å­˜50æ¢ï¼‰
      if(savedReports.length > 50) {
        savedReports = savedReports.slice(0, 50);
      }
      
      // ä¿å­˜æ•¸æ“š
      saveData();
      
      // æ›´æ–°é¡¯ç¤º
      renderSavedReports();
      
      alert('æ•¸æ“šå·²å„²å­˜ï¼åŒ…å« ' + baggingRecords.length + ' ç‰ˆè©³ç´°è¨˜éŒ„å’Œæœ¬åœ°æ•¸æ“š');
    }

    // æ–°å¢ï¼šå¡«å……ç‰ˆè™Ÿé¸æ“‡å™¨å‡½æ•¸
    function populatePlateNumberSelect() {
      const selectElement = document.getElementById('plateNumber');
      selectElement.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

      const usedPlateNumbers = new Set(baggingRecords.map(r => r.plateNumber));
      const startNumber = 1;
      const endNumber = 999; // å‡è¨­ç‰ˆè™Ÿç¯„åœç‚º 1 åˆ° 999ï¼Œå¯æ ¹æ“šéœ€è¦èª¿æ•´

      let hasAvailablePlate = false;

      for (let i = startNumber; i <= endNumber; i++) {
        const plateNum = String(i); // å–®ç´”çš„æ•¸å­—ç‰ˆè™Ÿ
        if (!usedPlateNumbers.has(plateNum)) {
          const option = document.createElement('option');
          option.value = plateNum;
          option.textContent = plateNum;
          selectElement.appendChild(option);
          hasAvailablePlate = true;
        }
      }

      if (!hasAvailablePlate) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ç„¡å¯ç”¨ç‰ˆè™Ÿ';
        option.disabled = true;
        selectElement.appendChild(option);
        selectElement.value = ''; // ç¢ºä¿æ²’æœ‰é¸ä¸­ä»»ä½•å€¼
      } else {
        // å¦‚æœæœ‰å¯ç”¨ç‰ˆè™Ÿï¼Œé è¨­é¸ä¸­ç¬¬ä¸€å€‹
        selectElement.selectedIndex = 0;
      }
    }

    window.onload=loadData;
  </script>
</body>
</html>
